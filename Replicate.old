#!/usr/local/bin/zsh
cd /TopStor
so=`echo $@ | awk '{print $1}'`;
dst=`echo $@ | awk '{print $2}'`;
export RR="hello";
snap=`echo $@ | awk '{print $3}'`
pool=`echo $@ | awk '{print $4}'`;
vol=`echo $@ | awk '{print $5}'`;
pp=$(( 3000+( $(od -An -N2 -i /dev/random) )%(4000-1024+1) ))
echo Replicate=$REMOTE >> txt/tmprequest
./Remoterequest.sh $so $dst rep RemoteVolSearch $vol;
sleep 3
echo envReplicate=`env` >> txt/tmprequest
volfound=$REMOTE;
echo volfound=$volfound >> txt/tmprequest
if [[ $volfound == "no" ]];
then
 echo no >> txt/tmprequest
 volpar=`./RemoteGetPoolVollist $vol`;
 prot=`echo $volpar | awk '{print $1}'`;
 size=`echo $volpar | awk '{print $2}'`;
 ./Remoterequest.sh $so $dst nop VolumeCreate$prot $pool $vol ${size}M admin; 
 echo /Remoterequest.sh $so $dst nop VolumeCreate$prot $pool $vol ${size}M admin >> txt/tmprequest
 sleep 2
 ./Remoterequest.sh $so $dst nop repli.sh $pp $pool ;
 ./Remoterequest.sh $so $dst nop GetPoolVollist hi & 
 zfs send -D $pool/$vol@$snap  | openssl enc -a -A -aes-256-cbc -k SuperSecretPWD | gzip -cf | nc -N  $dst $pp ;
else 
 if [[ $volfound == "found" ]];
 then
  echo foundfoundfoundfoudnfoundofudnffoudnsdoufndfousdn >> txt/tmprequest
  oldsnaps=`./Remoterequest.sh $so $dst rep RemoteGetSnaplist $vol`;
  localsnaps=`./RemoteGetSnaplist $vol`;
  ll=$oldsnaps;
  ll=${ll}' spot';
  echo ll=$ll >> txt/tmprequest
  lineupsnaps=`echo $ll | tr ' ' '\n' `
  initialsnap="";
  echo $lineupsnaps | while read -r line  
  do
  if [[ ${localsnaps/$line} == $localsnaps ]];
  then ; else initialsnap=$line;  break; fi;
  done;
  targetsnap=$pool/$vol@$snap
  echo targetsnap=$targetsnap >> txt/tmprequest
  echo initialsnap=$initialsnap >> txt/tmprequest
  if [[ $initialsnap == $targetsnap ]]; 
  then echo up-to-date >> txt/tmprequest; fi
  echo ./Remoterequest.sh $so $dst nop repli.sh $pp $pool >> txt/tmprequest
  if [[ $initialsnap == "" ]];
  then 
   echo yyyyyyyyyyyyyintital is null >> txt/tmprequest 
   ./Remoterequest.sh $so $dst rep destroysnaps.sh $vol ;
   ./Remoterequest.sh $so $dst nop repli.sh $pp $pool ;
   echo zfs send -R   $targetsnap  \| openssl enc -a -A -aes-256-cbc -k SuperSecretPWD \| gzip -cf \| nc -N  $dst $pp >> txt/tmprequest
   zfs send -R   $targetsnap  | openssl enc -a -A -aes-256-cbc -k SuperSecretPWD | gzip -cf | nc -N  $dst $pp;
  else
   ./Remoterequest.sh $so $dst nop repli.sh $pp $pool ;
   zfs send -R -I $initialsnap  $targetsnap  | openssl enc -a -A -aes-256-cbc -k SuperSecretPWD | gzip -cf | nc -N  $dst $pp;
  fi
 fi
fi
./GetSnaplist &
 ./Remoterequest.sh $so $dst nop GetSnaplist hi & 
