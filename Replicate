#!/usr/local/bin/zsh
cd /TopStor
so=`echo $@ | awk '{print $1}'`;
dst=`echo $@ | awk '{print $2}'`;

snap=`echo $@ | awk '{print $3}'`
pool=`echo $@ | awk '{print $4}'`;
vol=`echo $@ | awk '{print $5}'`;
prot=`echo $@ | awk '{print $6}'`;
size=`echo $@ | awk '{print $7}'`;
pp=$(( 3000+( $(od -An -N2 -i /dev/random) )%(4000-1024+1) ))
#nc -l 3333 |  gunzip | openssl enc -d  -a -A -aes-256-cbc -k SuperSecretPWD | zfs receive -d  Data

volfound=`./Remoterequest.sh $so $dst rep RemoteVolSearch $vol | awk '{print $2}'`;
echo volfound=$volfound
if [[ $volfound == "no" ]];
then
 ./Remoterequest.sh $so $dst nop VolumeCreate$prot $pool $vol ${size}M admin; 
 ./Remoterequest.sh $so $dst nop repli.sh $pp $pool ;
 zfs send -D $pool/$vol@$snap  | openssl enc -a -A -aes-256-cbc -k SuperSecretPWD | gzip -cf | nc -N  $dst $pp ;
 ./Remoterequest.sh $so $dst nop GetSnaplist hi ;
else if [[ $volfound == "found" ]];
then
echo replicating;
./Remoterequest.sh $so $dst nop repli.sh $pp $pool 
echo sent zfs receive
sleep 2;
echo $pool/$vol@$snap
sleep 2;
zfs send -R $pool/$vol@$snap  | openssl enc -a -A -aes-256-cbc -k SuperSecretPWD | gzip -cf | nc -N  $dst $pp
fi
fi

